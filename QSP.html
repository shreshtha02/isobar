<!DOCTYPE html>
<html lang="en" ng-app="web-app">
	<head>
	    <meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <meta http-equiv="pragma" content="no-cache" />
	    <link rel="shortcut icon" href="https://3x5yp62s8loz3jw8273enqos16xh-wpengine.netdna-ssl.com/wp-content/themes/cp3/favicon.ico?ver1" type="image/png">
	    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	    
	    <title>QSP tool</title>
	    <base href="/">
   		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
	    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Gudea">
	    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
	    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
	    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/xlsx.full.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/jszip.js"></script>
	</head>
	<body>
		
		<style>
			@media only screen and (min-width: 1024px){
				.logo {
					height: auto !important;
					margin-left: 30px !important; 
					width: 11.25rem !important;
					margin-top:-10px;
				}
				
				#copy{
					display:block !important;
				}
				#copy_mobile{
					display:none !important;
				}
			}
			html{
				font-family:"franklin-gothic-urw",sans-serif !important;
			}
			select{
				display:block;
				border: 1px solid lightgrey !important;
				    margin: 0 0 15px 0 !important;
			}
			.logo{
				/*height:60px;
				padding-top:15px;*/
				display: block;
				height: 2.125rem;
				position: absolute;
				left: -1rem;
				top: 1.2rem;
				width: 8.125rem;
			}
			.container{
				top:60px;
				position:relative;
				border:1px solid black;
			/*	left:50px !important;*/
				margin:0px 0px 10px 10px;
			}
			
			.leftpad{
				margin-left:20px;
			}
			input{
				border: 1px solid lightgrey !important;
				padding-left: 10px !important;
			}
			
			.pink{
				background-color:#e1005d !important;
			}
			.picker__frame{
				margin-top:-10px !important;
			}
			.picker__table{
				margin-top:-10px !important;
				margin-bottom: -10px !important;
			}
			#cover{
			    position:fixed;
			    top:0;
			    left:0;
			    background:rgba(0,0,0,0.6);
			    z-index:5;
			    width:100%;
			    height:100%;
			    display:none;
			}
			
			#modal1{
			  transition: all .3s ease;
			  -webkit-transition: all .3s ease;
			  animation: scale-display .3s;
                          display: none;
			}
			
			#inputFile{
				margin-top:15px;
			}
			
			@keyframes scale-display {
				0% {
					opacity: 0;
					transform: scale(0);
			    -webkit-transform: scale(0);
				}
				100% {
					opacity: 1;
					transform: scale(1);
			    -webkit-transform: scale(1);
				}
			}
			@keyframes scale-display--reversed {
				0% {
					display: inline-flex;
					opacity: 1;
					transform: scale(1);
					-webkit-transform: scale(1);
				}
				99% {
					display: inline-flex;
					opacity: 0;
					transform: scale(0);
					-webkit-transform: scale(0);
				}
				100% {
					display: none;
					opacity: 0;
					transform: scale(0);
					-webkit-transform: scale(0);
				}
			}
			
		</style>
		<header>	
			<main>
				<nav>
					<div class="nav-wrapper z-depth-0 white">
						<ul class="left">      	 
							<img src="https://3x5yp62s8loz3jw8273enqos16xh-wpengine.netdna-ssl.com/wp-content/themes/cp3/images/cardinal-path-logo.png" class="logo" >
						</ul>
						<ul class="hide-on-med-and-down right">
						</ul>
					</div>
				</nav>
			</main>	
		</header>
		<div class="row col s12 m12 l12">
			<!--Add buttons to initiate auth sequence and sign out
			 <button id="authorize-button" style="display: none;">Authorize</button>
			 <button id="signout-button" style="display: none;">Sign Out</button>-->
			<div class="row col s10 m8 l8 offset-s1 offset-m2 offset-l2 z-depth-1 container">
				<h4 align="center">QSP</h4>
				<div class="row"></div>
				<div class="col l12 m12 s12">
					<div class="col s12 m4 l3">
						<p>Upload excel file</p>
					</div>
					<div class="col s12 m7 l8 offset-l1" id="inputFile">
					<!--	<input id="fileSelect" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" onchange="ExcelToJSON()"/>-->
						<input type="file" id="fileUpload" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" onchange="Upload()"/>
						<div id="dvExcel"></div>
					</div>
				</div>
				<div class="col l7 m7 s7 offset-s5 offset-m5 offset-l5">
					<div class="preloader-wrapper small" id="loader">
						<div class="spinner-layer spinner-green-only">
							<div class="circle-clipper left">
								<div class="circle"></div>
							</div>
							<div class="gap-patch">
								<div class="circle"></div>
							</div>
							<div class="circle-clipper right">
								<div class="circle"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="row col s4 m2 l4 offset-s2 offset-l4 offset-m4" style="padding-top:7px;">
						<button class="btn waves-effect center waves-light pink disabled" type="submit" name="action" onclick="makeApiCall()" id="process">Process Data & save
        					<i class="material-icons right">send</i></button>
				</div>
			</div>
			
			<!-- Modal Structure -->
			  <div id="modal1" class="modal" style="z-index: 100;top:30%;overflow:hidden;">
			    <div class="modal-content">
			      <h5 align="center">Authenticate yourself by logging into your Google account</h5>
			    </div>
			    <div class="modal-footer center">
				<div class="row">
			      		<button class="btn waves-effect center waves-light pink" id="authorize-button1" style="display: block; margin-left:  auto;  margin-right: auto; float:none;">Authorize</button>
				<!--	<button class="btn waves-effect center waves-light pink" id="signout-button" style="display: none; margin-left:  auto;  margin-right: auto; float:none;">Signout</button>-->
				</div>
			    </div>
			  </div>
			<div id="cover">
  		</div>
		<!--script--->
  		<script>
// Client ID and API key from the Developer Console
		      var CLIENT_ID = '622320244089-k2r7rkiaadpm5sufp415jcofa8m2ss20.apps.googleusercontent.com';
		      var API_KEY = 'AIzaSyA8m2aF8gfWqyw7D9_4oioznw4sTnyyiDE';
		      // Array of API discovery doc URLs for APIs used by the quickstart
		      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
		      // Authorization scopes required by the API; multiple scopes can be
		      // included, separated by spaces.
		      var SCOPES = "https://www.googleapis.com/auth/spreadsheets";
		      var authorizeButton = document.getElementById('authorize-button1');
		      var signoutButton = document.getElementById('signout-button');
		      /**
		       *  On load, called to load the auth2 library and API client library.
		       */
		      function handleClientLoad() {
				gapi.load('client:auth2', initClient);
		      }
		      /**
		       *  Initializes the API client library and sets up sign-in state
		       *  listeners.
		       */
		      function initClient() {
				gapi.client.init({
				  apiKey: API_KEY,
				  clientId: CLIENT_ID,
				  discoveryDocs: DISCOVERY_DOCS,
				  scope: SCOPES
				}).then(function () {
				  // Listen for sign-in state changes.
				  gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
				  // Handle the initial sign-in state.
				  updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
						
				  authorizeButton.onclick = handleAuthClick;
				//  signoutButton.onclick = handleSignoutClick;
				});
		      }
		      /**
		       *  Called when the signed in status changes, to update the UI
		       *  appropriately. After a sign-in, the API is called.
		       */
		      function updateSigninStatus(isSignedIn) {
				if (isSignedIn) {
					//signoutButton.style.display = 'block';
				  authorizeButton.style.display = 'none';
				  document.getElementById("modal1").style.display='none';
				  document.getElementById("cover").style.display='none';
				  

				} else {
				  authorizeButton.style.display = 'block';  
				  document.getElementById("modal1").style.display='block';
				  document.getElementById("cover").style.display='block';
				 // signoutButton.style.display = 'none';
				}
		      }
		      /**
		       *  Sign in the user upon button click.
		       */
		      function handleAuthClick(event) {
				gapi.auth2.getAuthInstance().signIn();
		      }
		      /**
		       *  Sign out the user upon button click.
		       */
		      function handleSignoutClick(event) {
				gapi.auth2.getAuthInstance().signOut();
		      }
			
			 /**
		       * Append a pre element to the body containing the given message
		       * as its text node. Used to display the results of the API call.
		       *
		       * @param {string} message Text to be placed in pre element.
		       */
		      function appendPre(message) {
				var pre = document.getElementById('content');
				var textContent = document.createTextNode(message + '\n');
				pre.appendChild(textContent);
		      }
		      /**
		       * Print the names and majors of students in a sample spreadsheet:
		       * https://docs.google.com/spreadsheets/d/1ks-O7G5HCeTlpuWwdD7zO6ThNW77SxBfc8eNLRdcO9A/edit
		       */
				var urlList=[];
				var keyPairList=[];
				var keyValuePair=[];
				var queryData=[];
				var keyValuePairList = [];
			
			
			function Upload() {
				console.log('uploading');
				jQuery('#loader').addClass("active");
				//Reference the FileUpload element.
				var fileUpload = document.getElementById("fileUpload");
		 
				//Validate whether File is valid Excel file.
				var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xls|.xlsx)$/;
				if (regex.test(fileUpload.value.toLowerCase())) {
					if (typeof (FileReader) != "undefined") {
						var reader = new FileReader();
		 
						//For Browsers other than IE.
						if (reader.readAsBinaryString) {
							reader.onload = function (e) {
								ProcessExcel(e.target.result);
							};
							reader.readAsBinaryString(fileUpload.files[0]);
						} else {
							//For IE Browser.
							reader.onload = function (e) {
								var data = "";
								var bytes = new Uint8Array(e.target.result);
								for (var i = 0; i < bytes.byteLength; i++) {
									data += String.fromCharCode(bytes[i]);
								}
								ProcessExcel(data);
							};
							reader.readAsArrayBuffer(fileUpload.files[0]);
						}
					} else {
						alert("This browser does not support HTML5.");
					}
				} else {
					alert("Please upload a valid Excel file.");
				}
			};
			function ProcessExcel(data) {
				//Read the Excel File data.
				var workbook = XLSX.read(data, {
					type: 'binary'
				});
		 
				//Fetch the name of First Sheet.
				var firstSheet = workbook.SheetNames[1];
		 
				//Read all rows from First Sheet into an JSON array.
				var excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[firstSheet]);
		 
				//Create a HTML Table element.
			/*	var table = document.createElement("table");
				table.border = "1";
		 
				//Add the header row.
				var row = table.insertRow(-1);
		 
				//Add the header cells.
				var headerCell = document.createElement("TH");
				headerCell.innerHTML = "Page URL";
				row.appendChild(headerCell);*/
		 
				//Add the data rows from Excel file.
				for (var i = 0; i < excelRows.length-1; i++) {
					//Add the data row.
				//	var row = table.insertRow(-1);
		 
					//Add the data cells.
				//	var cell = row.insertCell(-1);
				//	cell.innerHTML = excelRows[i].Page_Path;
					urlList.push(excelRows[i].Page);
					if (excelRows[i].Page.split('?')[1] != undefined) {
						keyPairList.push(excelRows[i].Page.split('?')[1]);
					}
				}
				
				for (var i = 0; i < keyPairList.length; i++) {
					while(keyPairList[i].length > 0) {
						if(keyPairList[i].indexOf("&") > 0){
							queryData=[];
							keyValuePair.push(keyPairList[i].split('&')[0]);
							queryData.push(keyValuePair[keyValuePair.length-1].split('=')[0]);
							queryData.push(keyValuePair[keyValuePair.length-1].split('=')[1]);
							queryData.push(1);
							keyValuePairList.push(queryData);
							keyPairList[i] = keyPairList[i].slice((keyPairList[i].indexOf("&")+1), keyPairList[i].length);
						}
						else{
							queryData=[];
							keyValuePair.push(keyPairList[i]);
							queryData.push(keyValuePair[keyValuePair.length-1].split('=')[0]);
							queryData.push(keyValuePair[keyValuePair.length-1].split('=')[1]);
							queryData.push(1);
							keyValuePairList.push(queryData);
							keyPairList[i] = "";
						}
					}
				}
		 		
				for (var i = 0; i < keyValuePairList.length; i++) {
					var currentKey = keyValuePairList[i];
					for(var j = i+1; j < keyValuePairList.length; j++){
						if(keyValuePairList[j][0] == currentKey[0]){
							if(keyValuePairList[j][1] == currentKey[1]){
								keyValuePairList.splice(j, 1);
								keyValuePairList[i][2] = keyValuePairList[i][2]+1;
							}
						}
					}
				}
				
				jQuery('#process').removeClass("disabled");
				jQuery('#loader').removeClass("active");
			/*	var dvExcel = document.getElementById("dvExcel");
				dvExcel.innerHTML = "";
				dvExcel.appendChild(table);*/
			};
			
			
			function makeApiCall() {
				jQuery('#loader').addClass("active");
				var params = {
				// The ID of the spreadsheet to update.
				spreadsheetId: '1l7t1ksqQWdKjLFZRmoi8h9R5gj596I_zFH310UzeE2E', 
				// The A1 notation of the values to update.
				range: 'Detailed data!A1:E5',  // TODO: Update placeholder value.
				// How the input data should be interpreted.
				valueInputOption: 'USER_ENTERED',  // TODO: Update placeholder value.
			      };
			      var valueRangeBody = {
				// TODO: Add desired properties to the request body. All existing properties
				// will be replaced.
			      };
				var resource = {
				  "majorDimension": "ROWS",
				  "values":[
					   
					  ]
					  ,
				}
				for (var i = 0; i < keyValuePairList.length; i++) {
					resource.values.push(keyValuePairList[i]);
				}
			      var request = gapi.client.sheets.spreadsheets.values.append(params, resource);
      				request.then(function(response) {
				// TODO: Change code below to process the `response` object:
					//Copy..
					jQuery('#loader').removeClass("active");
				   var $toastContent = $('<span>Information saved</span>');
				   Materialize.toast($toastContent, 5000, 'rounded');
				  document.location.reload(true);
					window.open('https://docs.google.com/spreadsheets/d/1l7t1ksqQWdKjLFZRmoi8h9R5gj596I_zFH310UzeE2E/edit?pli=1#gid=134186671', '_blank');
				console.log(response.result);
			      }, function(reason) {
				console.error('error: ' + reason.result.error.message);
				if(reason.result.error.message=="The caller does not have permission"){
				   var $toastContent = $('<span>The caller does not have permission</span>');
				   Materialize.toast($toastContent, 5000, 'rounded');
				}
			      });
			    }
			
		    </script>

		    <script async defer src="https://apis.google.com/js/api.js"
		      onload="this.onload=function(){};handleClientLoad()"
		      onreadystatechange="if (this.readyState === 'complete') this.onload()">
		    </script>
	</body>
</html>
